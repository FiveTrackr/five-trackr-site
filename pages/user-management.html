<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin Dashboard - 5ive Trackr</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .logo-text h1 {
            font-size: 28px;
            color: #1f2937;
            font-weight: 700;
        }

        .logo-text p {
            font-size: 14px;
            color: #6b7280;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Statistics Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid;
        }

        .stat-card.revenue {
            border-left-color: #10b981;
        }

        .stat-card.tenants {
            border-left-color: #3b82f6;
        }

        .stat-card.users {
            border-left-color: #8b5cf6;
        }

        .stat-card.venues {
            border-left-color: #f59e0b;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #1f2937;
        }

        .stat-change {
            font-size: 12px;
            margin-top: 5px;
        }

        .stat-change.positive {
            color: #10b981;
        }

        .stat-change.negative {
            color: #ef4444;
        }

        /* Search and Filters */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .filter-btn {
            padding: 12px 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-btn:hover {
            background: #f9fafb;
        }

        .add-tenant-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .add-tenant-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        /* Tenant Cards */
        .tenants-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tenant-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .tenant-card.expanded {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .tenant-header {
            padding: 20px;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .tenant-header:hover {
            background: #f3f4f6;
        }

        .tenant-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tenant-avatar {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .tenant-details h3 {
            font-size: 18px;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .tenant-details p {
            font-size: 14px;
            color: #6b7280;
        }

        .tenant-status {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .subscription-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .subscription-badge.active {
            background: #d1fae5;
            color: #065f46;
        }

        .subscription-badge.trial {
            background: #fef3c7;
            color: #92400e;
        }

        .subscription-badge.suspended {
            background: #fee2e2;
            color: #991b1b;
        }

        .expand-icon {
            width: 24px;
            height: 24px;
            transition: transform 0.3s ease;
        }

        .tenant-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .tenant-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .tenant-card.expanded .tenant-content {
            max-height: 1000px;
        }

        .tenant-metrics {
            padding: 20px;
            background: #fafafa;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
        }

        .metric-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 5px;
        }

        .managers-details {
            padding: 20px;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .managers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .managers-header h4 {
            color: #1f2937;
            font-size: 16px;
            margin: 0;
        }

        .managers-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .manager-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .manager-item label {
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .manager-item value {
            color: #6b7280;
            font-size: 14px;
            font-family: monospace;
        }

        .subscription-details {
            padding: 20px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subscription-header h4 {
            color: #1f2937;
            font-size: 16px;
        }

        .manage-subscription-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .delete-tenant-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }

        .delete-tenant-btn:hover {
            background: #dc2626;
        }

        .subscription-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .subscription-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
        }

        .subscription-item label {
            font-size: 13px;
            color: #6b7280;
        }

        .subscription-item value {
            font-size: 13px;
            font-weight: 500;
            color: #1f2937;
        }

        .addons-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .addons-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .addons-header h5 {
            font-size: 14px;
            color: #1f2937;
        }

        .add-addon-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
        }

        .addon-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .addon-tag {
            padding: 6px 12px;
            background: #ede9fe;
            color: #5b21b6;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .users-section {
            padding: 20px;
        }

        .users-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .users-header h4 {
            color: #1f2937;
            font-size: 16px;
        }

        .add-user-btn {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
        }

        .users-table th {
            text-align: left;
            padding: 12px;
            background: #f9fafb;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .users-table td {
            padding: 12px;
            border-top: 1px solid #e5e7eb;
            font-size: 14px;
            color: #1f2937;
        }

        .user-avatar-small {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e5e7eb;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
        }

        .user-info-cell {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
        }

        .role-badge.admin {
            background: #fee2e2;
            color: #991b1b;
        }

        .role-badge.manager {
            background: #dbeafe;
            color: #1e40af;
        }

        .role-badge.user {
            background: #f3f4f6;
            color: #4b5563;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 6px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
        }

        .action-btn.edit {
            background: #fef3c7;
            color: #92400e;
        }

        .action-btn.delete {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #1f2937;
            font-size: 24px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .form-section h4 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-info {
            margin-bottom: 20px;
            padding: 12px;
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
        }

        .form-info p {
            margin: 0;
            color: #0c4a6e;
            font-size: 14px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 25px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #4b5563;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        /* Login Section */
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h2 {
            color: #1f2937;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .login-header p {
            color: #6b7280;
            font-size: 14px;
        }

        .login-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .search-box {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div id="loginContainer" class="login-container">
        <div class="login-header">
            <div class="logo-icon" style="margin: 0 auto 20px; width: 80px; height: 80px; font-size: 36px;">5T</div>
            <h2>Super Admin Access</h2>
            <p>Manage all tenants and subscriptions</p>
        </div>
        <div id="loginMessage"></div>
        <div class="form-group">
            <label for="adminEmail">Email Address</label>
            <input type="email" id="adminEmail" placeholder="admin@5ivetrackr.com" value="admin@5ivetrackr.com">
        </div>
        <div class="form-group">
            <label for="adminPassword">Password</label>
            <input type="password" id="adminPassword" placeholder="Enter password">
        </div>
        <button class="login-btn" onclick="authenticate()">Access Dashboard</button>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboardContainer" class="dashboard-container hidden">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">5T</div>
                <div class="logo-text">
                    <h1>Super Admin Dashboard</h1>
                    <p>Manage Tenants & Subscriptions</p>
                </div>
            </div>
            <div class="header-actions">
                <span id="adminName" style="color: #6b7280; font-size: 14px;">admin@5ivetrackr.com</span>
                <button class="logout-btn" onclick="logout()">Logout</button>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card revenue">
                <div class="stat-label">Monthly Revenue</div>
                <div class="stat-value" id="statRevenue">$0</div>
                <div class="stat-change positive">+0% from last month</div>
            </div>
            <div class="stat-card tenants">
                <div class="stat-label">Active Tenants</div>
                <div class="stat-value" id="statTenants">0</div>
                <div class="stat-change positive">+0 this month</div>
            </div>
            <div class="stat-card users">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="statUsers">0</div>
                <div class="stat-change positive">+0 this week</div>
            </div>
            <div class="stat-card venues">
                <div class="stat-label">Total Venues</div>
                <div class="stat-value" id="statVenues">0</div>
                <div class="stat-change positive">+0 this month</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <input type="text" class="search-box" id="searchTenants" placeholder="Search tenants by name, email, or ID..." oninput="filterTenants()">
            <button class="filter-btn" onclick="showFilterModal()">
                <span>⚙️</span> Filters
            </button>
            <button class="add-tenant-btn" onclick="showAddTenantModal()">
                <span>➕</span> Add Tenant
            </button>
        </div>

        <!-- Tenants Container -->
        <div id="tenantsContainer" class="tenants-container">
            <!-- Tenant cards will be dynamically inserted here -->
        </div>
    </div>

    <!-- Add/Edit Tenant Modal -->
    <div id="tenantModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tenantModalTitle">Add New Tenant</h2>
                <button class="close-modal" onclick="closeTenantModal()">×</button>
            </div>
            <form id="tenantForm">
                <div class="form-section">
                    <h4>🏆 League Manager</h4>
                    <div class="form-group">
                        <label for="leagueManagerEmail">Email Address *</label>
                        <input type="email" id="leagueManagerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="leagueManagerName">Full Name *</label>
                        <input type="text" id="leagueManagerName" required>
                    </div>
                    <div class="form-group">
                        <label for="leagueManagerPassword">Password *</label>
                        <input type="password" id="leagueManagerPassword" required placeholder="Enter password for league manager">
                    </div>
                </div>

                <div class="form-section">
                    <h4>👥 Assistant Manager (Optional)</h4>
                    <p style="font-size: 12px; color: #6b7280; margin: -5px 0 10px 0;">
                        Leave blank if no assistant manager is needed. If you fill any field, all fields become required.
                    </p>
                    <div class="form-group">
                        <label for="assistantManagerEmail">Email Address</label>
                        <input type="email" id="assistantManagerEmail" placeholder="assistant@example.com">
                    </div>
                    <div class="form-group">
                        <label for="assistantManagerName">Full Name</label>
                        <input type="text" id="assistantManagerName" placeholder="Assistant Manager Name">
                    </div>
                    <div class="form-group">
                        <label for="assistantManagerPassword">Password</label>
                        <input type="password" id="assistantManagerPassword" placeholder="Enter password for assistant manager">
                    </div>
                </div>

                <div class="form-section">
                    <h4>📊 Subscription</h4>
                    <div class="form-group">
                        <label for="tenantTier">Subscription Tier *</label>
                        <select id="tenantTier" required>
                            <option value="starter">Starter (£49.99/month) - 1 pitch, 10 referees, 1 league, 1 division per league, 10 teams</option>
                            <option value="growth">Growth (£99.99/month) - 3 pitches, 25 referees, 5 leagues, 3 divisions per league, 150 teams</option>
                            <option value="pro">Pro (£179.99/month) - 8 pitches, 50 referees, 10 leagues, 5 divisions per league, 500 teams</option>
                            <option value="super">Super Tenant - Unlimited access to all features (no subscription required)</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeTenantModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save Tenant</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Add User</h2>
                <button class="close-modal" onclick="closeUserModal()">×</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userTenantId">
                <div class="form-group">
                    <label for="userEmail">Email Address *</label>
                    <input type="email" id="userEmail" required>
                </div>
                <div class="form-group">
                    <label for="userName">Full Name *</label>
                    <input type="text" id="userName" required>
                </div>
                <div class="form-group">
                    <label for="userRole">Role *</label>
                    <select id="userRole" required>
                        <option value="admin">Admin</option>
                        <option value="manager">Manager</option>
                        <option value="referee">Referee</option>
                        <option value="user">User</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="userPassword">Password *</label>
                    <input type="password" id="userPassword" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeUserModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // === HYBRID API CONFIGURATION ===
        // Supports both local development and production testing
        function getApiBaseUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const isLocalTesting = urlParams.has('local') || window.location.search.includes('local=true');
            
            if (isLocalTesting) {
                console.log('🔧 LOCAL TESTING MODE: Using localhost API');
                return 'http://localhost:8080/api';
            } else {
                console.log('🌐 PRODUCTION MODE: Using live API');
                return 'https://five-trackr-yq6ly.ondigitalocean.app/api';
            }
        }
        
        const API_BASE = getApiBaseUrl();
        
        let accessToken = null;
        let tenants = [];
        let currentTenantId = null;

        // SHA-256 Hash Function
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Authentication
        async function authenticate() {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value;

            if (!email || !password) {
                showMessage('loginMessage', 'Please enter email and password', 'error');
                return;
            }

            if (email !== 'admin@5ivetrackr.com') {
                showMessage('loginMessage', 'Access restricted to super admin only', 'error');
                return;
            }

            try {
                const hashedPassword = await sha256(password);
                
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password: hashedPassword })
                });

                if (!response.ok) {
                    showMessage('loginMessage', 'Invalid credentials', 'error');
                    return;
                }

                const result = await response.json();
                accessToken = result.token || result.access_token;

                if (!accessToken) {
                    showMessage('loginMessage', 'Authentication failed', 'error');
                    return;
                }

                // Show dashboard
                document.getElementById('loginContainer').classList.add('hidden');
                document.getElementById('dashboardContainer').classList.remove('hidden');
                
                // Load data
                await loadTenants();
                updateStatistics();

            } catch (error) {
                console.error('Auth error:', error);
                showMessage('loginMessage', 'Network error: ' + error.message, 'error');
            }
        }

        // Logout
        function logout() {
            accessToken = null;
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('dashboardContainer').classList.add('hidden');
            document.getElementById('adminPassword').value = '';
        }

        // Load Tenants
        async function loadTenants() {
            try {
                console.log('🔄 Loading tenants from API...');
                const headers = { 'Content-Type': 'application/json' };
                if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;

                const response = await fetch(`${API_BASE}/admin/tenants`, {
                    method: 'GET',
                    headers
                });

                if (response.ok) {
                    const data = await response.json();
                    tenants = data.tenants || [];
                    console.log(`✅ Loaded ${tenants.length} tenants:`, tenants);
                    displayTenants();
                } else {
                    console.error('❌ Failed to load tenants:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('Error details:', errorText);
                    tenants = [];
                    displayTenants();
                }
            } catch (error) {
                console.error('❌ Network error loading tenants:', error);
                tenants = [];
                displayTenants();
            }
        }

        // Display Tenants
        function displayTenants() {
            console.log(`📋 Displaying ${tenants.length} tenants`);
            const container = document.getElementById('tenantsContainer');
            
            if (tenants.length === 0) {
                console.log('📊 No tenants to display - showing empty state');
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 20px;">📊</div>
                        <h3 style="font-size: 20px; margin-bottom: 10px;">No Tenants Yet</h3>
                        <p>Click "Add Tenant" to create your first tenant</p>
                    </div>
                `;
                return;
            }

            console.log('🏗️ Creating tenant cards for:', tenants.map(t => t.email || t.name));
            container.innerHTML = tenants.map(tenant => createTenantCard(tenant)).join('');
            console.log('✅ Tenant cards displayed successfully');
        }

        // Create Tenant Card
        function createTenantCard(tenant) {
            const tenantId = tenant.id || tenant.user_id;
            // Get subscription details based on tier
            const getSubscriptionDefaults = (tier) => {
                const subscriptionTiers = {
                    'starter': {
                        status: 'active',
                        plan_name: 'Starter',
                        tier_id: 'starter',
                        base_price: 49.99,
                        pitches_limit: 1,
                        referees_limit: 10,
                        leagues_limit: 1,
                        divisions_per_league_limit: 1,
                        teams_limit: 10 // 1 league × 1 division × 10 teams
                    },
                    'growth': {
                        status: 'active',
                        plan_name: 'Growth',
                        tier_id: 'growth',
                        base_price: 99.99,
                        pitches_limit: 3,
                        referees_limit: 25,
                        leagues_limit: 5,
                        divisions_per_league_limit: 3,
                        teams_limit: 150 // 5 leagues × 3 divisions × 10 teams
                    },
                    'pro': {
                        status: 'active',
                        plan_name: 'Pro',
                        tier_id: 'pro',
                        base_price: 179.99,
                        pitches_limit: 8,
                        referees_limit: 50,
                        leagues_limit: 10,
                        divisions_per_league_limit: 5,
                        teams_limit: 500 // 10 leagues × 5 divisions × 10 teams
                    },
                    'super': {
                        status: 'active',
                        plan_name: 'Super Tenant',
                        tier_id: 'super',
                        base_price: 0,
                        pitches_limit: '∞',
                        referees_limit: '∞',
                        leagues_limit: '∞',
                        divisions_per_league_limit: '∞',
                        teams_limit: '∞'
                    }
                };
                return subscriptionTiers[tier] || subscriptionTiers['starter'];
            };
            
            const subscription = tenant.subscription || getSubscriptionDefaults(tenant.tier || 'starter');

            return `
                <div class="tenant-card" id="tenant-${tenantId}">
                    <div class="tenant-header" onclick="toggleTenant('${tenantId}')">
                        <div class="tenant-info">
                            <div class="tenant-avatar">${getInitials(tenant.name || tenant.full_name || tenant.email)}</div>
                            <div class="tenant-details">
                                <h3>${tenant.name || tenant.full_name || 'Unnamed Tenant'}</h3>
                                <p>${tenant.email}</p>
                            </div>
                        </div>
                        <div class="tenant-status">
                            <span class="subscription-badge ${subscription.status}">${subscription.status.toUpperCase()}</span>
                            <svg class="expand-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div class="tenant-content">
                        <div class="tenant-metrics">
                            <div class="metric">
                                <div class="metric-value">${tenant.user_count || 0}</div>
                                <div class="metric-label">Users</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${tenant.venue_count || 0}</div>
                                <div class="metric-label">Venues</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">£${subscription.base_price || 0}</div>
                                <div class="metric-label">Monthly</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${tenant.storage_used || 0}GB</div>
                                <div class="metric-label">Storage</div>
                            </div>
                        </div>
                        <div class="managers-details">
                            <div class="managers-header">
                                <h4>Allocated Managers</h4>
                            </div>
                            <div class="managers-info">
                                <div class="manager-item">
                                    <label>🏆 League Manager:</label>
                                    <value>${tenant.email}</value>
                                </div>
                                <div class="manager-item">
                                    <label>👥 Assistant Manager:</label>
                                    <value>${tenant.assistant_manager && tenant.assistant_manager.email ? tenant.assistant_manager.email : 'N/A'}</value>
                                </div>
                            </div>
                        </div>
                        <div class="subscription-details">
                            <div class="subscription-header">
                                <h4>Subscription Details</h4>
                                <div>
                                    <button class="manage-subscription-btn" onclick="manageSubscription('${tenantId}')">Manage</button>
                                    <button class="delete-tenant-btn" onclick="deleteTenant('${tenantId}', '${tenant.email}')">Delete</button>
                                </div>
                            </div>
                            <div class="subscription-info">
                                <div class="subscription-item">
                                    <label>Tier:</label>
                                    <value>${subscription.plan_name} ${subscription.base_price > 0 ? `(£${subscription.base_price}/month)` : '(Free)'}</value>
                                </div>
                                <div class="subscription-item">
                                    <label>Pitches:</label>
                                    <value>${tenant.pitch_count || 0} / ${subscription.pitches_limit}</value>
                                </div>
                                <div class="subscription-item">
                                    <label>Referees:</label>
                                    <value>${tenant.referee_count || 0} / ${subscription.referees_limit}</value>
                                </div>
                                <div class="subscription-item">
                                    <label>Leagues:</label>
                                    <value>${tenant.league_count || 0} / ${subscription.leagues_limit}</value>
                                </div>
                                <div class="subscription-item">
                                    <label>Divisions/League:</label>
                                    <value>${tenant.divisions_per_league_count || 0} / ${subscription.divisions_per_league_limit}</value>
                                </div>
                                <div class="subscription-item">
                                    <label>Teams:</label>
                                    <value>${tenant.team_count || 0} / ${subscription.teams_limit}</value>
                                </div>
                                <div class="subscription-item">
                                    <label>Next Billing:</label>
                                    <value>${subscription.next_billing_date || 'N/A'}</value>
                                </div>
                            </div>
                            ${subscription.addons && subscription.addons.length > 0 ? `
                                <div class="addons-section">
                                    <div class="addons-header">
                                        <h5>Active Add-ons</h5>
                                        <button class="add-addon-btn" onclick="addAddon('${tenantId}')">Add More</button>
                                    </div>
                                    <div class="addon-list">
                                        ${subscription.addons.map(addon => `
                                            <span class="addon-tag">
                                                ${addon.type} x${addon.quantity}
                                                <span style="cursor: pointer;" onclick="removeAddon('${tenantId}', '${addon.id}')">×</span>
                                            </span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="users-section">
                            <div class="users-header">
                                <h4>Tenant Users</h4>
                                <button class="add-user-btn" onclick="showAddUserModal('${tenantId}')">Add User</button>
                            </div>
                            <div id="users-${tenantId}">
                                <p style="color: #6b7280; font-size: 14px;">Loading users...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle Tenant Card
        async function toggleTenant(tenantId) {
            const card = document.getElementById(`tenant-${tenantId}`);
            card.classList.toggle('expanded');
            
            if (card.classList.contains('expanded')) {
                await loadTenantUsers(tenantId);
            }
        }

        // Load Tenant Users
        async function loadTenantUsers(tenantId) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;

                const response = await fetch(`${API_BASE}/admin/users?tenant=${tenantId}`, {
                    method: 'GET',
                    headers
                });

                if (response.ok) {
                    const users = await response.json();
                    displayTenantUsers(tenantId, users);
                } else {
                    displayTenantUsers(tenantId, []);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                displayTenantUsers(tenantId, []);
            }
        }

        // Display Tenant Users
        function displayTenantUsers(tenantId, users) {
            const container = document.getElementById(`users-${tenantId}`);
            
            if (users.length === 0) {
                container.innerHTML = '<p style="color: #6b7280; font-size: 14px;">No users created yet</p>';
                return;
            }

            container.innerHTML = `
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Role</th>
                            <th>Last Login</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${users.map(user => `
                            <tr>
                                <td>
                                    <div class="user-info-cell">
                                        <div class="user-avatar-small">${getInitials(user.fullName || user.email)}</div>
                                        <div>
                                            <div style="font-weight: 500;">${user.fullName || 'Unknown'}</div>
                                            <div style="font-size: 12px; color: #6b7280;">${user.email}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="role-badge ${getRoleClass(user.role)}">${user.role}</span>
                                </td>
                                <td style="font-size: 13px; color: #6b7280;">
                                    ${user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}
                                </td>
                                <td>
                                    <div class="user-actions">
                                        <button class="action-btn edit" onclick="editUser('${tenantId}', '${user.id}')">Edit</button>
                                        <button class="action-btn delete" onclick="deleteUser('${tenantId}', '${user.id}')">Delete</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Update Statistics
        function updateStatistics() {
            const activeTenants = tenants.filter(t => t.subscription?.status === 'active').length;
            const totalUsers = tenants.reduce((sum, t) => sum + (t.user_count || 0), 0);
            const totalVenues = tenants.reduce((sum, t) => sum + (t.venue_count || 0), 0);
            const monthlyRevenue = tenants.reduce((sum, t) => sum + (t.subscription?.base_price || 0), 0);

            document.getElementById('statRevenue').textContent = `$${monthlyRevenue}`;
            document.getElementById('statTenants').textContent = activeTenants;
            document.getElementById('statUsers').textContent = totalUsers;
            document.getElementById('statVenues').textContent = totalVenues;
        }

        // Filter Tenants
        function filterTenants() {
            const searchTerm = document.getElementById('searchTenants').value.toLowerCase();
            const cards = document.querySelectorAll('.tenant-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'block' : 'none';
            });
        }

        // Modal Functions
        function showAddTenantModal() {
            document.getElementById('tenantModalTitle').textContent = 'Add New Tenant';
            document.getElementById('tenantForm').reset();
            document.getElementById('tenantModal').classList.add('active');
        }

        function closeTenantModal() {
            document.getElementById('tenantModal').classList.remove('active');
        }

        function showAddUserModal(tenantId) {
            currentTenantId = tenantId;
            document.getElementById('userTenantId').value = tenantId;
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').classList.add('active');
        }

        function closeUserModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        function manageSubscription(tenantId) {
            alert(`Subscription management for tenant ${tenantId} - Feature coming soon!`);
        }

        async function deleteTenant(tenantId, tenantEmail) {
            // Confirm deletion
            const confirmMessage = `Are you sure you want to delete tenant "${tenantEmail}"?\n\nThis will permanently delete:\n- The tenant and assistant manager accounts\n- All tenant data\n- The tenant database\n\nThis action cannot be undone!`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                console.log(`🗑️ Attempting to delete tenant: ${tenantId} (${tenantEmail})`);
                
                if (!accessToken) {
                    throw new Error('Authentication required. Please log in first.');
                }

                const headers = { 'Content-Type': 'application/json' };
                headers['Authorization'] = `Bearer ${accessToken}`;

                const response = await fetch(`${getApiBaseUrl()}/admin/tenants/${tenantId}`, {
                    method: 'DELETE',
                    headers
                });

                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorData}`);
                }

                const result = await response.json();
                console.log('✅ Tenant deletion successful:', result);
                
                // Show success message
                alert(`Tenant "${tenantEmail}" has been successfully deleted.`);
                
                // Refresh the tenant list
                await loadTenants();

            } catch (error) {
                console.error('❌ Tenant deletion failed:', error);
                alert(`Failed to delete tenant: ${error.message}`);
            }
        }

        // Helper Functions
        function getInitials(name) {
            if (!name) return '?';
            const parts = name.split(/[@\s]+/);
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        function getRoleClass(role) {
            if (role === 'admin' || role === 'league_manager') return 'admin';
            if (role === 'manager' || role === 'tenant_manager') return 'manager';
            return 'user';
        }

        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, 5000);
        }

        // Form Submissions
        document.getElementById('tenantForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Validate required fields for league manager (always required)
            const leagueManagerEmail = document.getElementById('leagueManagerEmail').value.trim();
            const leagueManagerName = document.getElementById('leagueManagerName').value.trim();
            const leagueManagerPassword = document.getElementById('leagueManagerPassword').value;
            
            if (!leagueManagerEmail || !leagueManagerName || !leagueManagerPassword) {
                alert('Please fill in all required fields for League Manager');
                return;
            }
            
            if (leagueManagerPassword.length < 6) {
                alert('League Manager password must be at least 6 characters long');
                return;
            }
            
            // Check assistant manager fields (optional)
            const assistantManagerEmail = document.getElementById('assistantManagerEmail').value.trim();
            const assistantManagerName = document.getElementById('assistantManagerName').value.trim();
            const assistantManagerPassword = document.getElementById('assistantManagerPassword').value;
            
            // If any assistant manager field is filled, all must be filled
            const hasAnyAssistantField = assistantManagerEmail || assistantManagerName || assistantManagerPassword;
            
            if (hasAnyAssistantField) {
                if (!assistantManagerEmail || !assistantManagerName || !assistantManagerPassword) {
                    alert('If creating an Assistant Manager, all fields must be filled (email, name, and password)');
                    return;
                }
                
                if (assistantManagerPassword.length < 6) {
                    alert('Assistant Manager password must be at least 6 characters long');
                    return;
                }
                
                if (leagueManagerEmail === assistantManagerEmail) {
                    alert('League Manager and Assistant Manager must have different email addresses');
                    return;
                }
            }
            
            const tenantData = {
                league_manager: {
                    email: leagueManagerEmail,
                    full_name: leagueManagerName,
                    password: leagueManagerPassword,
                    user_role: 'league_manager'
                },
                subscription: {
                    tier: document.getElementById('tenantTier').value
                }
            };
            
            // Only add assistant manager if fields are provided
            if (hasAnyAssistantField) {
                tenantData.assistant_manager = {
                    email: assistantManagerEmail,
                    full_name: assistantManagerName,
                    password: assistantManagerPassword,
                    user_role: 'assistant_manager'
                };
            }

            try {
                const headers = { 'Content-Type': 'application/json' };
                if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;

                const response = await fetch(`${API_BASE}/admin/tenants`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(tenantData)
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('✅ Tenant created successfully:', result);
                    
                    // Show success message with manager accounts
                    const successMessageParts = [
                        `✅ Tenant created successfully!`,
                        `🏆 League Manager: ${leagueManagerEmail} (${leagueManagerName})`
                    ];
                    
                    if (hasAnyAssistantField) {
                        successMessageParts.push(`👥 Assistant Manager: ${assistantManagerEmail} (${assistantManagerName})`);
                    } else {
                        successMessageParts.push(`ℹ️ No Assistant Manager created`);
                    }
                    
                    successMessageParts.push(
                        `📊 Tier: ${result.tier || document.getElementById('tenantTier').selectedOptions[0].text.split(' ')[0]}`,
                        `🔐 ${hasAnyAssistantField ? 'Both accounts' : 'The account'} can now login with the provided credentials.`
                    );
                    
                    const successMessage = successMessageParts.join('\n');
                    
                    alert(successMessage);
                    
                    // Close modal and refresh data
                    closeTenantModal();
                    await loadTenants();
                    updateStatistics();
                    
                    console.log('📊 Refreshed tenant list and statistics');
                } else {
                    const errorText = await response.text();
                    console.error('❌ Failed to create tenant:', response.status, errorText);
                    
                    let errorMessage = 'Failed to create tenant';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.error || errorData.message || errorText;
                    } catch {
                        errorMessage = errorText || 'Unknown error occurred';
                    }
                    
                    alert('❌ Error creating tenant: ' + errorMessage);
                }
            } catch (error) {
                console.error('Error creating tenant:', error);
                alert('Error creating tenant: ' + error.message);
            }
        });

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const userData = {
                email: document.getElementById('userEmail').value,
                fullName: document.getElementById('userName').value,
                role: document.getElementById('userRole').value,
                password: document.getElementById('userPassword').value,
                tenant_id: document.getElementById('userTenantId').value
            };

            try {
                const hashedPassword = await sha256(userData.password);
                userData.password = hashedPassword;

                const headers = { 'Content-Type': 'application/json' };
                if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;

                const response = await fetch(`${API_BASE}/data/users`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        action: 'create',
                        user: userData
                    })
                });

                if (response.ok) {
                    closeUserModal();
                    await loadTenantUsers(userData.tenant_id);
                } else {
                    const error = await response.text();
                    alert('Failed to create user: ' + error);
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user: ' + error.message);
            }
        });

        // Initialize
        window.addEventListener('load', () => {
            console.log('Super Admin Dashboard initialized');
            console.log('API Base:', API_BASE);
        });
    </script>
</body>
</html>